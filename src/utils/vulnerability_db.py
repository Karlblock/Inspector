"""
Vulnerability pattern database
"""

class VulnerabilityDB:
    def __init__(self):
        self.patterns = {
            'web': {
                'login_page': [
                    {
                        'type': 'Authentication Bypass',
                        'description': 'Login pages may be vulnerable to SQL injection or authentication bypass',
                        'severity': 'High',
                        'tests': [
                            "admin' OR '1'='1",
                            "admin' --",
                            "' OR 1=1 --"
                        ]
                    },
                    {
                        'type': 'Brute Force',
                        'description': 'Login forms without rate limiting are vulnerable to brute force',
                        'severity': 'Medium',
                        'tools': ['hydra', 'burpsuite']
                    }
                ],
                'upload_page': [
                    {
                        'type': 'Unrestricted File Upload',
                        'description': 'File upload without proper validation can lead to RCE',
                        'severity': 'Critical',
                        'tests': [
                            'PHP shell upload',
                            'Extension bypass (.php.jpg)',
                            'Content-Type manipulation'
                        ]
                    }
                ],
                'cdn-cgi': [
                    {
                        'type': 'Information Disclosure',
                        'description': 'CDN paths may expose sensitive information or admin panels',
                        'severity': 'Medium',
                        'note': 'Often used to hide admin functionality'
                    }
                ]
            },
            'services': {
                'ftp': [
                    {
                        'type': 'Anonymous Access',
                        'description': 'FTP service may allow anonymous login',
                        'severity': 'Medium',
                        'test_command': 'ftp -n <IP> (user: anonymous)'
                    }
                ],
                'smb': [
                    {
                        'type': 'Null Session',
                        'description': 'SMB may allow null session enumeration',
                        'severity': 'Medium',
                        'test_command': 'smbclient -L //<IP> -N'
                    },
                    {
                        'type': 'EternalBlue',
                        'description': 'Older SMB versions vulnerable to MS17-010',
                        'severity': 'Critical',
                        'check': 'nmap --script smb-vuln-ms17-010'
                    }
                ]
            }
        }
    
    def check_vulnerabilities(self, service):
        """Check for vulnerability patterns"""
        
        vulnerabilities = []
        
        # Check service-specific patterns
        service_name = service.get('name', '').lower()
        
        if service_name in self.patterns['services']:
            vulnerabilities.extend(self.patterns['services'][service_name])
        
        # Check for web-specific patterns
        if service.get('port') in ['80', '443', '8080', '8443']:
            # Add generic web vulnerabilities
            vulnerabilities.append({
                'type': 'Web Application',
                'description': 'Web service detected - check for common web vulnerabilities',
                'severity': 'Info',
                'checklist': [
                    'Directory enumeration',
                    'Technology stack identification',
                    'Input validation testing',
                    'Authentication testing'
                ]
            })
        
        return vulnerabilities
    
    def get_attack_methodology(self, vulnerability_type):
        """Get attack methodology for a vulnerability type"""
        
        methodologies = {
            'SQL Injection': {
                'detection': [
                    "Add single quote (') to parameters",
                    "Look for SQL errors",
                    "Time-based detection with SLEEP()"
                ],
                'exploitation': [
                    "Identify injection point",
                    "Determine database type",
                    "Extract data with UNION SELECT",
                    "Use sqlmap for automation"
                ],
                'tools': ['sqlmap', 'burpsuite', 'manual testing']
            },
            'File Upload': {
                'detection': [
                    "Locate upload functionality",
                    "Test allowed extensions",
                    "Check upload directory accessibility"
                ],
                'exploitation': [
                    "Upload PHP/ASP/JSP shell",
                    "Bypass filters (double extension, null byte)",
                    "Use image header with embedded code",
                    "Check for directory traversal in filename"
                ],
                'tools': ['burpsuite', 'custom scripts', 'weevely']
            }
        }
        
        return methodologies.get(vulnerability_type, {})